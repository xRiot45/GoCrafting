# ------------------------------------------------------------
# docker-compose.yml (Production-Ready Template)
# ------------------------------------------------------------
# This template demonstrates a structured Docker Compose setup
# for a Go service with supporting infrastructure.
#
# Included services:
# - app (Go service)
# - postgres (database)
# - redis (cache)
# - nginx (reverse proxy)
#
# You may remove services you don't need.
#
# Documentation:
# https://docs.docker.com/compose/
# ------------------------------------------------------------

version: "3.9"

# ============================================================
# Networks
# ============================================================
networks:
  app_network:
    driver: bridge

# ============================================================
# Volumes
# ============================================================
volumes:
  postgres_data:
  redis_data:

# ============================================================
# Services
# ============================================================
services:

  # ----------------------------------------------------------
  # Go Application Service
  # ----------------------------------------------------------
  app:
    container_name: go_app
    build:
      context: .
      dockerfile: Dockerfile
      args:
        BINARY_NAME: app

    image: go-app:latest

    restart: unless-stopped

    ports:
      - "8080:8080"

    env_file:
      - .env

    depends_on:
      - postgres
      - redis

    networks:
      - app_network

    # Mount only for development (optional)
    # volumes:
    #   - .:/app

    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8080/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s


  # ----------------------------------------------------------
  # PostgreSQL Database
  # ----------------------------------------------------------
  postgres:
    image: postgres:16-alpine
    container_name: postgres_db

    restart: unless-stopped

    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: app_db

    ports:
      - "5432:5432"

    volumes:
      - postgres_data:/var/lib/postgresql/data

    networks:
      - app_network


  # ----------------------------------------------------------
  # Redis Cache
  # ----------------------------------------------------------
  redis:
    image: redis:7-alpine
    container_name: redis_cache

    restart: unless-stopped

    ports:
      - "6379:6379"

    volumes:
      - redis_data:/data

    command: ["redis-server", "--appendonly", "yes"]

    networks:
      - app_network


  # ----------------------------------------------------------
  # Nginx Reverse Proxy (Optional)
  # ----------------------------------------------------------
  nginx:
    image: nginx:alpine
    container_name: nginx_proxy

    restart: unless-stopped

    ports:
      - "80:80"

    volumes:
      - ./deployments/nginx.conf:/etc/nginx/nginx.conf:ro

    depends_on:
      - app

    networks:
      - app_network


# ------------------------------------------------------------
# OPTIONAL PROFILES (Development vs Production)
# ------------------------------------------------------------
# Example usage:
# docker compose --profile dev up
# docker compose --profile prod up
# ------------------------------------------------------------

# profiles:
#   dev:
#   prod:


# ------------------------------------------------------------
# EXAMPLE COMMANDS
# ------------------------------------------------------------
# Start services:
# docker compose up -d
#
# Build services:
# docker compose build
#
# Stop services:
# docker compose down
#
# Remove volumes:
# docker compose down -v
#
# View logs:
# docker compose logs -f app
# ------------------------------------------------------------


# ------------------------------------------------------------
# BEST PRACTICES
# ------------------------------------------------------------
# 1. Store secrets in environment variables or secret manager.
# 2. Use .env file for local development only.
# 3. Avoid exposing database ports in production.
# 4. Use external networks in multi-project environments.
# 5. Pin image versions for deterministic builds.
# 6. Add resource limits in production deployments.
# ------------------------------------------------------------


# ------------------------------------------------------------
# RESOURCE LIMITS EXAMPLE (Uncomment if needed)
# ------------------------------------------------------------
# deploy:
#   resources:
#     limits:
#       cpus: "0.50"
#       memory: 512M
#     reservations:
#       cpus: "0.25"
#       memory: 256M
# ------------------------------------------------------------